@model IEnumerable<Trang_tin_điện_tử_mvc.Models.Article>
@using System.Security.Claims

@{
    bool isAuth = User.Identity.IsAuthenticated && User.IsInRole("Author");
    bool isAdmin = User.Identity.IsAuthenticated && User.IsInRole("Admin");    
    var categories = ViewBag.Categories as List<Trang_tin_điện_tử_mvc.Models.Category>;
    var authors = ViewBag.Authors as List<string>;
    ViewData["Title"] = "Quản lý Bài viết";
}

<div class="container-fluid px-4 py-4">

    @* --- HEADER --- *@
    <div class="d-flex justify-content-between align-items-center mb-4 bg-white p-3 rounded shadow-sm border">
        <div>
            <h1 class="h3 text-primary fw-bold mb-1"><i class="bi bi-kanban me-2"></i>@ViewData["Title"]</h1>
            <p class="text-muted mb-0 small">Quản lý danh sách, trạng thái và kiểm duyệt nội dung.</p>
        </div>
        <div class="d-flex gap-2">           
            <a asp-action="Create" class="btn btn-primary shadow-sm"><i class="bi bi-plus-lg me-1"></i> Viết bài mới</a>
        </div>
    </div>

    @* --- THANH CÔNG CỤ TÌM KIẾM & BỘ LỌC --- *@
    <div class="card shadow-sm border-0 mb-4">
        <div class="card-body bg-light">
            <div class="row g-3">

                @* 1. Tìm kiếm từ khóa *@
                <div class="col-md-3">
                    <input type="text" id="adminSearchInput" class="form-control"
                           placeholder="Tìm từ khóa..." value="@ViewData["CurrentFilter"]">
                </div>

                @* 2. Lọc theo Danh mục *@
                <div class="col-md-2">
                    <select id="filterCategory" class="form-select">
                        <option value="">-- Tất cả Danh mục --</option>
                        @if (categories != null)
                        {
                            foreach (var cat in categories)
                            {
                                <option value="@cat.Id" selected="@(ViewData["FilterCategory"]?.ToString() == cat.Id.ToString())">@cat.Name</option>
                            }
                        }
                    </select>
                </div>

                @* 3. Lọc theo Tác giả *@
                <div class="col-md-2">
                    <select id="filterAuthor" class="form-select">
                        <option value="">-- Tất cả Tác giả --</option>
                        @if (authors != null)
                        {
                            foreach (var auth in authors)
                            {
                                <option value="@auth" selected="@(ViewData["FilterAuthor"]?.ToString() == auth)">@auth</option>
                            }
                        }
                    </select>
                </div>

                @* 4. Lọc theo Trạng thái (Chỉ Admin thấy) *@
                @if (isAdmin)
                {
                    <div class="col-md-2">
                        <select id="filterStatus" class="form-select">
                            <option value="">-- Tất cả Trạng thái --</option>
                            <option value="approved" selected="@(ViewData["FilterStatus"]?.ToString() == "approved")">Đã duyệt</option>
                            <option value="pending" selected="@(ViewData["FilterStatus"]?.ToString() == "pending")">Chờ duyệt</option>
                        </select>
                    </div>
                }

                @* 5. Nút Reset *@
                <div class="col-md-auto">
                    <button id="btnResetFilters" class="btn btn-outline-secondary w-100" title="Xóa bộ lọc">
                        <i class="bi bi-arrow-counterclockwise"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    @* --- KHUNG CHỨA BẢNG DỮ LIỆU (SẼ ĐƯỢC AJAX CẬP NHẬT) --- *@
    <div class="card shadow-sm border-0 overflow-hidden">
        <div class="card-body p-0" id="adminTableContainer">
            @* Gọi Partial View lần đầu tiên *@
            <partial name="_ArticleTablePartial" model="Model" />
        </div>
    </div>

</div>

@section Scripts {
    <script>
            $(document).ready(function () {
            let typingTimer;
            const doneTypingInterval = 500;

            // Các element input
            const $searchInput = $('#adminSearchInput');
            const $categorySelect = $('#filterCategory');
            const $authorSelect = $('#filterAuthor');
            const $statusSelect = $('#filterStatus');
            const $container = $('#adminTableContainer');

            // --- HÀM TÌM KIẾM CHUNG ---
            // Hàm này sẽ gom tất cả giá trị từ các ô input để gửi đi
            function performSearch() {
                // Lấy giá trị từ các ô
                var keyword = $searchInput.val().trim();
                var catId = $categorySelect.val();
                var author = $authorSelect.val();
                var status = $statusSelect.val(); // Có thể undefined nếu không phải admin

                // Tạo URL với query string
                var url = '@Url.Action("Index", "Articles")';
                var params = new URLSearchParams();

                if(keyword) params.append('searchString', keyword);
                if(catId) params.append('filterCategory', catId);
                if(author) params.append('filterAuthor', author);
                if(status) params.append('filterStatus', status);

                var fullUrl = url + '?' + params.toString();

                $container.css('opacity', 0.5);

                $.get(fullUrl, function (data) {
                    $container.html(data).css('opacity', 1);
                    // Update URL trình duyệt
                    window.history.pushState({ path: fullUrl }, '', fullUrl);
                }).fail(function () {
                    alert("Lỗi tải dữ liệu.");
                    $container.css('opacity', 1);
                });
            }

            // --- BẮT SỰ KIỆN ---

            // 1. Sự kiện gõ phím (Live Search)
            $searchInput.on('input', function () {
                clearTimeout(typingTimer);
                typingTimer = setTimeout(performSearch, doneTypingInterval);
            });

            // 2. Sự kiện thay đổi Dropdown (Category, Author, Status)
            // Khi chọn dropdown thì tìm ngay lập tức, không cần delay
            $('#filterCategory, #filterAuthor, #filterStatus').on('change', function() {
                performSearch();
            });

            // 3. Nút Reset
            $('#btnResetFilters').click(function() {
                $searchInput.val('');
                $categorySelect.val('');
                $authorSelect.val('');
                if($statusSelect.length) $statusSelect.val('');
                performSearch();
            });

            // 4. AJAX Pagination (Giữ nguyên logic cũ nhưng dùng performSearch gián tiếp hoặc lấy URL từ href)
            // Lưu ý: Link phân trang được tạo từ Server (Partial View) đã chứa sẵn các tham số lọc hiện tại
            // nên ta chỉ cần gọi $.get theo href là đủ.
            $(document).on('click', '#adminTableContainer .page-link', function (e) {
                e.preventDefault();
                var url = $(this).attr('href');
                if (url && url !== '#') {
                    $container.css('opacity', 0.5);
                    $.get(url, function (data) {
                        $container.html(data).css('opacity', 1);
                        window.history.pushState({ path: url }, '', url);
                    });
                }
            });
        });
    </script>
    <style>
        /* Style thanh cuộn đẹp hơn */
        .table-responsive::-webkit-scrollbar {
            height: 8px;
            width: 8px;
        }

        .table-responsive::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 4px;
        }

            .table-responsive::-webkit-scrollbar-thumb:hover {
                background: #aaa;
            }
    </style>
}