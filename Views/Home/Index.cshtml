@model Trang_tin_điện_tử_mvc.Models.HomeIndexViewModel
@using X.PagedList.Mvc.Core
@using X.PagedList.Web.Common

@{
    ViewData["Title"] = ViewData["Title"] ?? "Trang Chủ";

    // Lấy các tham số lọc
    var currentSearch = ViewData["CurrentFilter"] as string;
    var currentTag = ViewData["CurrentTag"] as string;
    var currentCategoryId = ViewData["CurrentCategoryId"] as int?;

    // Logic kiểm tra xem có đang ở chế độ lọc không
    bool isSearching = !string.IsNullOrEmpty(currentSearch);
    bool isFiltered = isSearching || !string.IsNullOrEmpty(currentTag) || currentCategoryId.HasValue;

    // Biến cho Hero Section
    var heroMain = Model.FeaturedArticles.ElementAtOrDefault(0);
    var heroLeft1 = Model.FeaturedArticles.ElementAtOrDefault(1);
    var heroLeft2 = Model.FeaturedArticles.ElementAtOrDefault(2);
    var heroRight1 = Model.FeaturedArticles.ElementAtOrDefault(3);
    var heroRight2 = Model.FeaturedArticles.ElementAtOrDefault(4);
}

<style>
    /* CSS Hero giữ nguyên như cũ */
    .hero-cnn-section .hero-main-title {
        font-size: 2.5rem;
        font-weight: 700;
        line-height: 1.1;
    }

    .hero-cnn-section .hero-main-card {
        position: relative;
    }

        .hero-cnn-section .hero-main-card .hero-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.9), rgba(0,0,0,0.0));
            padding: 1.5rem 1rem 1rem;
            color: white;
        }

            .hero-cnn-section .hero-main-card .hero-overlay h4 {
                font-weight: 700;
            }

    .hero-cnn-section .hero-card-img {
        width: 100%;
        object-fit: cover;
    }

    .hero-cnn-section .hero-card-left .hero-card-img {
        height: 180px;
    }

    .hero-cnn-section .hero-card-right .hero-card-img-small {
        width: 120px;
        height: 80px;
        object-fit: cover;
    }

    .hero-cnn-section .hero-card-right h6 {
        font-size: 0.95rem;
        font-weight: 600;
    }

    .hero-cnn-section .hero-card-left h5 {
        font-weight: 600;
    }

    .hero-cnn-section a {
        text-decoration: none;
        color: #212529;
    }

        .hero-cnn-section a:hover {
            color: #007bff;
        }

    .loading-overlay {
        opacity: 0.5;
        pointer-events: none;
        transition: opacity 0.3s;
    }

    /* Style cho Alert lọc */
    .filter-alert {
        background-color: #f8f9fa;
        border-left: 5px solid #0d6efd;
        padding: 1rem;
        margin-bottom: 1.5rem;
        border-radius: 4px;
    }

        .filter-alert h4 {
            margin: 0;
            font-size: 1.25rem;
            color: #495057;
        }

        .filter-alert strong {
            color: #0d6efd;
        }
</style>

<div class="container mt-4">
    <div class="row">
        <div class="col-lg-12">

            @* --- 1. HERO & CHUYÊN MỤC (Chỉ hiện khi KHÔNG lọc) --- *@
            <div id="home-sections" style="display: @(isFiltered ? "none" : "block")">

                @* Hero Section *@
                <section class="hero-cnn-section mb-4">
                    <div class="row g-3">
                        <div class="col-lg-3">
                            @if (heroLeft1 != null)
                            {
                                var img = !string.IsNullOrEmpty(heroLeft1.ThumbnailUrl) ? heroLeft1.ThumbnailUrl : "/uploads/articles/default-thumbnail.jpg";
                                <div class="card border-0 mb-3 hero-card-left">
                                    <a asp-controller="Articles" asp-action="Details" asp-route-id="@heroLeft1.Id">
                                        <img src="@img" class="card-img-top hero-card-img" onerror="this.src='/uploads/articles/default-thumbnail.jpg'">
                                        <div class="card-body px-0 pt-2"><h5 class="card-title mb-0">@heroLeft1.Title</h5></div>
                                    </a>
                                </div>
                            }
                            @if (heroLeft2 != null)
                            {
                                var img = !string.IsNullOrEmpty(heroLeft2.ThumbnailUrl) ? heroLeft2.ThumbnailUrl : "/uploads/articles/default-thumbnail.jpg";
                                <div class="card border-0 mb-3 hero-card-left">
                                    <a asp-controller="Articles" asp-action="Details" asp-route-id="@heroLeft2.Id">
                                        <img src="@img" class="card-img-top hero-card-img" onerror="this.src='/uploads/articles/default-thumbnail.jpg'">
                                        <div class="card-body px-0 pt-2"><h5 class="card-title mb-0">@heroLeft2.Title</h5></div>
                                    </a>
                                </div>
                            }
                        </div>
                        <div class="col-lg-6">
                            @if (heroMain != null)
                            {
                                var img = !string.IsNullOrEmpty(heroMain.ThumbnailUrl) ? heroMain.ThumbnailUrl : "/uploads/articles/default-thumbnail.jpg";
                                <h1 class="hero-main-title mb-2"><a asp-controller="Articles" asp-action="Details" asp-route-id="@heroMain.Id">@heroMain.Title</a></h1>
                                <div classs="card border-0 hero-main-card">
                                    <a asp-controller="Articles" asp-action="Details" asp-route-id="@heroMain.Id">
                                        <img src="@img" class="img-fluid" style="width: 100%; height: auto;" onerror="this.src='/uploads/articles/default-thumbnail.jpg'">
                                        <div class="hero-overlay"><h4>@heroMain.Summary</h4></div>
                                    </a>
                                </div>
                            }
                        </div>
                        <div class="col-lg-3">
                            @if (heroRight1 != null)
                            {
                                var img = !string.IsNullOrEmpty(heroRight1.ThumbnailUrl) ? heroRight1.ThumbnailUrl : "/uploads/articles/default-thumbnail.jpg";
                                <div class="card border-0 mb-3 hero-card-right">
                                    <a asp-controller="Articles" asp-action="Details" asp-route-id="@heroRight1.Id" class="row g-2 align-items-center">
                                        <div class="col-5"><img src="@img" class="img-fluid rounded hero-card-img-small" onerror="this.src='/uploads/articles/default-thumbnail.jpg'"></div>
                                        <div class="col-7"><h6>@heroRight1.Title</h6></div>
                                    </a>
                                </div>
                            }
                            <hr class="my-3">
                            @if (heroRight2 != null)
                            {
                                var img = !string.IsNullOrEmpty(heroRight2.ThumbnailUrl) ? heroRight2.ThumbnailUrl : "/uploads/articles/default-thumbnail.jpg";
                                <div class="card border-0 mb-3 hero-card-right">
                                    <a asp-controller="Articles" asp-action="Details" asp-route-id="@heroRight2.Id" class="row g-2 align-items-center">
                                        <div class="col-5"><img src="@img" class="img-fluid rounded hero-card-img-small" onerror="this.src='/uploads/articles/default-thumbnail.jpg'"></div>
                                        <div class="col-7"><h6>@heroRight2.Title</h6></div>
                                    </a>
                                </div>
                            }
                        </div>
                    </div>
                </section>

                @if (Model.BusinessStories.Any())
                {
                    <section class="mb-4">
                        <h3 class="border-bottom pb-2 mb-3 fw-bold"><a href="#" class="text-dark text-decoration-none">Kinh Tế</a></h3>
                        <div class="row g-3">
                            @foreach (var item in Model.BusinessStories)
                            {
                                <div class="col-md-6"><partial name="_ArticleCardPartial" model="item" /></div>
                            }
                        </div>
                    </section>
                }
                @if (Model.TechStories.Any())
                {
                    <section class="mb-4">
                        <h3 class="border-bottom pb-2 mb-3 fw-bold"><a href="#" class="text-dark text-decoration-none">Công Nghệ</a></h3>
                        <div class="row g-3">
                            @foreach (var item in Model.TechStories)
                            {
                                <div class="col-md-6"><partial name="_ArticleCardPartial" model="item" /></div>
                            }
                        </div>
                    </section>
                }
            </div>

            @* --- 2. THÔNG BÁO KHI ĐANG LỌC --- *@
            @if (isFiltered)
            {
                <div class="filter-alert" id="search-alert">
                    <h4>
                        @if (currentCategoryId.HasValue)
                        {
                            <span><i class="bi bi-folder-fill me-2"></i>Chuyên mục: <strong>@ViewData["Title"]?.ToString().Replace("Chuyên mục: ", "")</strong></span>
                        }
                        else if (!string.IsNullOrEmpty(currentTag))
                        {
                            <span><i class="bi bi-tags-fill me-2"></i>Thẻ Tag: <strong>@currentTag</strong></span>
                        }
                        else if (isSearching)
                        {
                            <span id="search-result-text"><i class="bi bi-search me-2"></i>Kết quả tìm kiếm: <strong>@currentSearch</strong></span>
                        }
                    </h4>
                </div>
            }

            @* --- 3. DANH SÁCH BÀI VIẾT --- *@
            <section class="mb-4">
                <h3 class="border-bottom pb-2 mb-3 fw-bold" id="list-title">
                    @(isFiltered ? "Danh sách bài viết" : "Tin Mới Nhất")
                </h3>

                @* Container này sẽ chứa cả Danh sách + Phân trang (do Partial cung cấp) *@
                <div id="latest-articles-container" style="min-height: 300px;">
                     <partial name="_ArticleListPartial" model="Model.LatestArticles" />
                </div>
            </section>
        </div>
    </div>
</div>
@section Scripts {
    <script>
        $(function () {
            let typingTimer;
            const doneTypingInterval = 500;
            const $container = $('#latest-articles-container');
            const $homeSections = $('#home-sections');
            const $listTitle = $('#list-title');
            const $pagination = $('.pagination-container');
            const $input = $('#layoutSearchInput');

            // 1. Live Search Logic (Khi gõ trên Layout)
            if ($input.length > 0) {
                $input.on('input', function () {
                    clearTimeout(typingTimer);
                    typingTimer = setTimeout(doneTyping, doneTypingInterval);
                });
            }

            function doneTyping() {
                var keyword = $input.val().trim();
                var url = '@Url.Action("Index", "Home")' + '?searchString=' + encodeURIComponent(keyword);
                $container.addClass('loading-overlay');

                $.get(url, function (data) {
                    $container.html(data).removeClass('loading-overlay');
                    if (keyword.length > 0) {
                        $homeSections.slideUp();
                        $listTitle.text('Kết quả tìm kiếm');

                        // Xóa alert cũ nếu có và thêm alert mới
                        $('.filter-alert').remove();
                        $('<div class="filter-alert mb-4"><h4><span><i class="bi bi-search me-2"></i>Kết quả tìm kiếm: <strong>' + keyword + '</strong></span></h4></div>').insertBefore($('section.mb-4:last'));

                        history.pushState(null, '', url);
                    } else {
                        $homeSections.slideDown();
                        $('.filter-alert').remove(); // Xóa alert khi hết tìm kiếm
                        $listTitle.text('Tin Mới Nhất');
                        history.pushState(null, '', '@Url.Action("Index", "Home")');
                    }

                    // Update pagination links
                    $pagination.find('a.page-link').each(function () {
                        var oldHref = $(this).attr('href');
                        if (oldHref) {
                            var newHref = updateQueryStringParameter(oldHref, 'searchString', keyword);
                            $(this).attr('href', newHref);
                        }
                    });
                }).fail(function () { console.error("Lỗi tìm kiếm."); $container.removeClass('loading-overlay'); });
            }

            function updateQueryStringParameter(uri, key, value) {
                var re = new RegExp("([?&])" + key + "=.*?(&|$)", "i");
                var separator = uri.indexOf('?') !== -1 ? "&" : "?";
                if (uri.match(re)) return uri.replace(re, '$1' + key + "=" + value + '$2');
                else return uri + separator + key + "=" + value;
            }

            // 2. AJAX Pagination
            $(document).on('click', '.pagination-container .page-link', function (e) {
                e.preventDefault();
                var url = $(this).attr('href');
                if (url && url !== '#') {
                    $container.addClass('loading-overlay');
                    $.get(url, function (data) {
                        $container.html(data).removeClass('loading-overlay');
                        $('html, body').animate({ scrollTop: $container.offset().top - 100 }, 400);
                        history.pushState(null, '', url);
                    });
                }
            });
            $(window).on('popstate', function () { location.reload(); });
        });
    </script>
}