@using Microsoft.AspNetCore.Identity
@using Trang_tin_điện_tử_mvc.Data
@using Trang_tin_điện_tử_mvc.Models

@inject SignInManager<ApplicationUser> SignInManager
@inject UserManager<ApplicationUser> UserManager
@inject ApplicationDbContext DbContext

@{
    var allCategories = DbContext.Categories.OrderBy(c => c.Name).ToList();
    var allTags = DbContext.Tags.OrderBy(t => t.Name).ToList();
}

<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>@ViewData["Title"] - AGU-News</title>

    @* --- CSS --- *@
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" />
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />

    <style>
        /* CSS cho Dropdown Gợi ý Tìm kiếm */
        .search-results-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            z-index: 1000;
            background-color: #fff;
            border: 1px solid rgba(0,0,0,.15);
            border-radius: 0.25rem;
            box-shadow: 0 0.5rem 1rem rgba(0,0,0,.175);
            max-height: 400px;
            overflow-y: auto;
            display: none; /* Ẩn mặc định */
        }

        .search-result-item {
            display: flex;
            align-items: center;
            padding: 10px;
            text-decoration: none;
            color: #212529;
            border-bottom: 1px solid #e9ecef;
            transition: background-color 0.2s;
        }

            .search-result-item:last-child {
                border-bottom: none;
            }

            .search-result-item:hover {
                background-color: #f8f9fa;
                color: #dc3545; /* Màu đỏ khi hover */
            }

        .search-thumb {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 4px;
            margin-right: 10px;
            flex-shrink: 0;
        }

        .search-info {
            flex-grow: 1;
            min-width: 0; /* Để text-truncate hoạt động */
        }

        .search-title {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .search-date {
            font-size: 0.75rem;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <header>
        <nav class="navbar navbar-expand-lg navbar-light shadow-sm fixed-top bg-white">
            <div class="container">
                <a class="navbar-brand fw-bold text-primary" asp-area="" asp-controller="Home" asp-action="Index">
                    📰 AGU-News
                </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                        <li class="nav-item"><a class="nav-link" asp-controller="Home" asp-action="Index">Trang chủ</a></li>

                        @* Dropdowns (Giữ nguyên code cũ của bạn) *@
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="catDrop" data-bs-toggle="dropdown">Chuyên mục</a>
                            <ul class="dropdown-menu">
                                @foreach (var c in allCategories)
                                {
                                    <li><a class="dropdown-item" asp-controller="Home" asp-action="Index" asp-route-categoryId="@c.Id">@c.Name</a></li>
                                }
                            </ul>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="tagDrop" data-bs-toggle="dropdown">Thẻ Tag</a>
                            <ul class="dropdown-menu">
                                @foreach (var t in allTags)
                                {
                                    <li><a class="dropdown-item" asp-controller="Home" asp-action="Index" asp-route-tag="@t.Name">@t.Name</a></li>
                                }
                            </ul>
                        </li>
                        <li class="nav-item"><a class="nav-link" asp-controller="Home" asp-action="Contact">Liên hệ</a></li>
                    </ul>

                    <div class="d-flex align-items-center gap-3">

                        @* --- KHU VỰC TÌM KIẾM (LIVE SEARCH) --- *@
                        <div class="position-relative">
                            <form class="d-flex" asp-controller="Home" asp-action="Index" method="get">
                                <div class="input-group">
                                    @* ID để JS bắt sự kiện *@
                                    <input class="form-control" type="search" name="searchString" id="layoutSearchInput"
                                           placeholder="Tìm kiếm..." autocomplete="off" style="min-width: 200px;">
                                    <button class="btn btn-outline-danger" type="submit"><i class="bi bi-search"></i></button>
                                </div>
                            </form>

                            @* Div chứa kết quả gợi ý *@
                            <div id="layoutSearchResults" class="search-results-dropdown"></div>
                        </div>

                        @* --- PHẦN USER (Giữ nguyên logic của bạn) --- *@
                        @if (SignInManager.IsSignedIn(User))
                        {
                            var currentUser = await UserManager.GetUserAsync(User);
                            var avatar = currentUser.AvatarUrl ?? "/uploads/avatars/default-images.png";
                            <div class="dropdown">
                                <a class="btn btn-outline-secondary border-0 dropdown-toggle d-flex align-items-center" href="#" data-bs-toggle="dropdown">
                                    <img src="@avatar" class="rounded-circle me-2" width="30" height="30" style="object-fit:cover"> @currentUser.UserName
                                </a>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    @if (User.IsInRole("Admin"))
                                    {
                                        <li><a class="dropdown-item" asp-area="Admin" asp-controller="AdminDashboard" asp-action="Index">Trang quản trị</a></li>
                                    }
                                    else if (User.IsInRole("Author"))
                                    {
                                        <li><a class="dropdown-item" asp-area="Admin" asp-controller="AuthorDashboard" asp-action="Index">Quản lý bài viết</a></li>
                                    }
                                    <li><a class="dropdown-item" asp-controller="Users" asp-action="Details" asp-route-id="@UserManager.GetUserId(User)">Thông tin cá nhân</a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li>
                                        <form asp-area="Identity" asp-page="/Account/Logout" method="post">
                                            <button type="submit" class="dropdown-item text-danger">Đăng xuất</button>
                                        </form>
                                    </li>
                                </ul>
                            </div>
                        }
                        else
                        {
                            <div class="d-flex gap-2">
                                <a class="btn btn-sm btn-outline-primary" asp-area="Identity" asp-page="/Account/Login">Đăng nhập</a>
                                <a class="btn btn-sm btn-primary" asp-area="Identity" asp-page="/Account/Register">Đăng ký</a>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <main class="container mt-5 pt-4 mb-5">
        @RenderBody()
    </main>

    @* --- FOOTER HIỆN ĐẠI --- *@
    <footer class="bg-dark text-light pt-5 pb-3 mt-auto">
        <div class="container">
            <div class="row g-4">

                @* CỘT 1: GIỚI THIỆU & LOGO *@
                <div class="col-lg-4 col-md-6">
                    <h5 class="text-uppercase fw-bold mb-3 text-primary">
                        <i class="bi bi-newspaper me-2"></i>AGU-News
                    </h5>
                    <p class="small text-secondary">
                        Trang thông tin điện tử cung cấp tin tức nóng hổi, chính xác và cập nhật liên tục. Nơi hội tụ những góc nhìn đa chiều về kinh tế, công nghệ và đời sống.
                    </p>
                    @* Social Media Icons *@
                    <div class="d-flex gap-3 mt-3">
                        <a href="#" class="text-light fs-5"><i class="bi bi-facebook"></i></a>
                        <a href="#" class="text-light fs-5"><i class="bi bi-youtube"></i></a>
                        <a href="#" class="text-light fs-5"><i class="bi bi-tiktok"></i></a>
                        <a href="#" class="text-light fs-5"><i class="bi bi-instagram"></i></a>
                    </div>
                </div>

                @* CỘT 2: CHUYÊN MỤC (Lấy từ Database) *@
                <div class="col-lg-2 col-md-6">
                    <h5 class="fw-bold mb-3">Chuyên mục</h5>
                    <ul class="list-unstyled small">
                        @if (DbContext.Categories.Any())
                        {
                            @* Lấy 6 chuyên mục đầu tiên *@
                            @foreach (var cat in DbContext.Categories.OrderBy(c => c.Name).Take(6))
                            {
                                <li class="mb-2">
                                    <a asp-controller="Home" asp-action="Index" asp-route-categoryId="@cat.Id"
                                       class="text-decoration-none text-secondary footer-link">
                                        @cat.Name
                                    </a>
                                </li>
                            }
                        }
                    </ul>
                </div>

                @* CỘT 3: LIÊN KẾT NHANH *@
                <div class="col-lg-2 col-md-6">
                    <h5 class="fw-bold mb-3">Thông tin</h5>
                    <ul class="list-unstyled small">
                        <li class="mb-2">
                            <a asp-controller="Home" asp-action="Terms" class="text-decoration-none text-secondary footer-link">Giới thiệu</a>
                        </li>
                        <li class="mb-2">
                            <a asp-controller="Home" asp-action="Contact" class="text-decoration-none text-secondary footer-link">Liên hệ</a>
                        </li>
                        <li class="mb-2">
                            <a asp-controller="Home" asp-action="Privacy" class="text-decoration-none text-secondary footer-link">Chính sách bảo mật</a>
                        </li>
                        <li class="mb-2">
                            <a asp-controller="Home" asp-action="Terms" class="text-decoration-none text-secondary footer-link">Điều khoản sử dụng</a>
                        </li>
                    </ul>
                </div>

                @* CỘT 4: LIÊN HỆ *@
                <div class="col-lg-4 col-md-6">
                    <h5 class="fw-bold mb-3">Liên hệ</h5>
                    <ul class="list-unstyled small text-secondary">
                        <li class="mb-3 d-flex">
                            <i class="bi bi-geo-alt-fill text-primary me-2 flex-shrink-0"></i>
                            <span>Phường Bình Đức, Thành phố Long Xuyên, Tỉnh An Giang</span>
                        </li>
                        <li class="mb-3 d-flex">
                            <i class="bi bi-envelope-fill text-primary me-2 flex-shrink-0"></i>
                            <span>nhan_dth225710@student.agu.edu.vn</span>
                        </li>
                        <li class="mb-3 d-flex">
                            <i class="bi bi-telephone-fill text-primary me-2 flex-shrink-0"></i>
                            <span>(+84) 866 710 544</span>
                        </li>
                    </ul>
                </div>
            </div>

            <hr class="border-secondary my-4">

            @* PHẦN COPYRIGHT *@
            <div class="row align-items-center">
                <div class="col-md-6 text-center text-md-start small text-secondary">
                    &copy; @DateTime.Now.Year <strong>AGU-News</strong>. Phát triển bởi Lê Trí Nhàn SV ĐH An Giang & Chat-GPT
                </div>
                <div class="col-md-6 text-center text-md-end mt-2 mt-md-0">
                    <span class="text-secondary small">Design with <i class="bi bi-heart-fill text-danger"></i> by ASP.NET Core</span>
                </div>
            </div>
        </div>
    </footer>

    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="~/js/site.js" asp-append-version="true"></script>

    @* --- SCRIPT XỬ LÝ LIVE SEARCH (AUTOCOMPLETE) --- *@
    <script>
        $(document).ready(function() {
            let searchTimer;
            const $input = $('#layoutSearchInput');
            const $dropdown = $('#layoutSearchResults');

            $input.on('input', function() {
                clearTimeout(searchTimer);
                const query = $(this).val().trim();

                if (query.length < 2) { // Chỉ tìm khi gõ >= 2 ký tự
                    $dropdown.hide().empty();
                    return;
                }

                // Hiện loading
                $dropdown.html('<div class="p-3 text-center text-muted"><span class="spinner-border spinner-border-sm"></span> Đang tìm...</div>').show();

                // Debounce 400ms
                searchTimer = setTimeout(function() {
                    $.ajax({
                        url: '@Url.Action("GetSearchSuggestions", "Home")', // Gọi API trong HomeController
                        data: { query: query },
                        success: function(data) {
                            if (data.length > 0) {
                                let html = '';
                                $.each(data, function(i, item) {
                                    // Tạo link chi tiết
                                    let detailUrl = '/Articles/Details/' + item.id;
                                    html += `
                                        <a href="${detailUrl}" class="search-result-item">
                                            <img src="${item.image}" class="search-thumb" onerror="this.src='/uploads/articles/default-thumbnail.jpg'">
                                            <div class="search-info">
                                                <h6 class="search-title">${item.title}</h6>
                                                <span class="search-date">${item.date}</span>
                                            </div>
                                        </a>`;
                                });
                                // Link "Xem tất cả"
                                let allUrl = '@Url.Action("Index", "Home")?searchString=' + encodeURIComponent(query);
                                html += `<a href="${allUrl}" class="search-result-item justify-content-center text-primary fw-bold bg-light p-2">Xem tất cả kết quả</a>`;

                                $dropdown.html(html);
                            } else {
                                $dropdown.html('<div class="p-3 text-center text-muted">Không tìm thấy kết quả.</div>');
                            }
                        },
                        error: function() {
                            $dropdown.html('<div class="p-3 text-center text-danger">Lỗi tìm kiếm.</div>');
                        }
                    });
                }, 400);
            });

            // Ẩn dropdown khi click ra ngoài
            $(document).on('click', function(e) {
                if (!$(e.target).closest('.position-relative').length) {
                    $dropdown.hide();
                }
            });

             // Hiện lại khi focus
            $input.on('focus', function() {
                if($(this).val().length >= 2 && $dropdown.children().length > 0) $dropdown.show();
            });
        });
    </script>

    @await RenderSectionAsync("Scripts", required: false)
</body>
</html>