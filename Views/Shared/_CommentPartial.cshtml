@using Microsoft.AspNetCore.Identity
@model Trang_tin_điện_tử_mvc.Models.Comment
@inject UserManager<ApplicationUser> UserManager
@inject SignInManager<ApplicationUser> SignInManager

@{
    // Lấy lại các biến đã truyền từ View chính qua ViewData
    var currentUserId = ViewData["CurrentUserId"] as string;
    var isUserAdmin = (bool)(ViewData["IsUserAdmin"] ?? false);
}

<li class="d-flex align-items-start mb-4 pb-3 border-bottom comment-item" id="comment-@Model.Id">
    @{
        var commentAvatar = Model.User?.AvatarUrl ?? "/uploads/avatars/default-images.png";
    }
    <img src="@commentAvatar" alt="Avatar" class="rounded-circle me-3" width="40" height="40"
         onerror="this.onerror=null; this.src='/uploads/avatars/default-images.png';" />

    <div class="w-100">
        <div class="d-flex justify-content-between align-items-center">
            <span class="fw-bold text-dark">@(Model.User?.UserName ?? "Người dùng ẩn danh")</span>
            <small class="text-muted">@Model.CreatedAt.ToString("dd/MM/yyyy 'lúc' HH:mm")</small>
        </div>

        <div class="comment-content-display">
            <p class="mb-0 mt-1 comment-content">@Model.Content</p>
        </div>

        <div class="comment-content-edit" style="display:none;">
            <form method="post" asp-action="EditComment" asp-controller="Articles" asp-antiforgery="true">
                <input type="hidden" name="commentId" value="@Model.Id" />
                <input type="hidden" name="articleId" value="@Model.ArticleId" />
                <textarea name="content" class="form-control form-control-sm mb-2" rows="3">@Model.Content</textarea>
                <button type="submit" class="btn btn-sm btn-primary">Lưu</button>
                <button type="button" class="btn btn-sm btn-light btn-cancel-edit">Hủy</button>
            </form>
        </div>

        @{
            // Kiểm tra quyền (Admin hoặc chính chủ bình luận)
            bool canModify = isUserAdmin || (currentUserId == Model.UserId);
        }

        <div class="comment-actions mt-2 small">
            @if (canModify)
            {
                <button type="button" class="btn btn-link btn-sm text-primary p-0 btn-edit-comment">
                    Sửa
                </button>
                <span class="mx-1">·</span>
                <form method="post" asp-action="DeleteComment" asp-controller="Articles" asp-antiforgery="true" class="d-inline"
                      onsubmit="return confirm('Bạn có chắc muốn xóa bình luận này?');">
                    <input type="hidden" name="commentId" value="@Model.Id" />
                    <input type="hidden" name="articleId" value="@Model.ArticleId" />
                    <button type="submit" class="btn btn-link btn-sm text-danger p-0">
                        Xóa
                    </button>
                </form>
            }

            @if (SignInManager.IsSignedIn(User))
            {
                if (canModify)
                {
                    <span class="mx-1">·</span>
                }
                <button type="button" class="btn btn-link btn-sm text-success p-0 btn-toggle-reply">
                    Trả lời
                </button>
            }
        </div>

        <div class="reply-form-container mt-3" style="display:none;">
            <form asp-action="ReplyToComment" asp-controller="Articles" method="post" class="comment-form">
                @Html.AntiForgeryToken()
                <input type="hidden" name="ArticleId" value="@Model.ArticleId" />
                <input type="hidden" name="ParentCommentId" value="@Model.Id" />
                <div class="w-100">
                    <textarea name="Content" class="form-control form-control-sm" rows="2" placeholder="Viết câu trả lời..." required></textarea>
                    <div class="d-flex justify-content-end mt-2">
                        <button type="submit" class="btn btn-primary btn-sm">Gửi trả lời</button>
                        <button type="button" class="btn btn-light btn-sm ms-2 btn-cancel-reply">Hủy</button>
                    </div>
                </div>
            </form>
        </div>
        @if (Model.Replies != null && Model.Replies.Any())
        {
            <ul class="list-unstyled mt-4" style="padding-left: 55px;">
                @foreach (var reply in Model.Replies.OrderBy(r => r.CreatedAt))
                {
                    <partial name="_CommentPartial" model="reply" view-data="ViewData" />
                }
            </ul>
        }
    </div>
</li>