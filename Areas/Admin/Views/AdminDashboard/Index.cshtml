@using Trang_tin_điện_tử_mvc.Models
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@{
    var topAuthorLabels = ViewBag.TopAuthorLabels as List<string> ?? new List<string>();
    var topAuthorData = ViewBag.TopAuthorData as List<int> ?? new List<int>();
    var topCommentArticleLabels = ViewBag.TopCommentArticleLabels as List<string> ?? new List<string>();
    var topCommentArticleData = ViewBag.TopCommentArticleData as List<int> ?? new List<int>();

    ViewData["Title"] = "Bảng điều khiển Admin";
}

@* TIÊU ĐỀ CHÍNH *@
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h2 text-primary fw-bold mb-0">
        <i class="bi bi-speedometer2 me-2"></i>Bảng điều khiển
    </h1>
    <span class="text-muted">@DateTime.Now.ToString("dddd, dd/MM/yyyy")</span>
</div>


@* CÁC THẺ THỐNG KÊ TỔNG QUAN *@
<div class="row g-4">
    <div class="col-xl-3 col-md-6">
        <div class="card shadow-sm border-start border-primary border-4 h-100">
            <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="card-title text-primary">NGƯỜI DÙNG</h5>
                    <div class="h2 fw-bold">@ViewBag.TotalUsers</div>
                </div>
                <div class="fs-1 text-primary opacity-50"><i class="bi bi-people-fill"></i></div>
            </div>
            <a asp-controller="Users" asp-area="" asp-action="Index" class="card-footer text-primary text-decoration-none">
                Quản lý người dùng <i class="bi bi-arrow-right-circle"></i>
            </a>
        </div>
    </div>
    <div class="col-xl-3 col-md-6">
        <div class="card shadow-sm border-start border-success border-4 h-100">
            <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="card-title text-success">BÀI VIẾT</h5>
                    <div class="h2 fw-bold">@ViewBag.TotalArticles</div>
                </div>
                <div class="fs-1 text-success opacity-50"><i class="bi bi-newspaper"></i></div>
            </div>
            <a asp-controller="Articles" asp-area="" asp-action="Index" class="card-footer text-success text-decoration-none">
                Quản lý bài viết <i class="bi bi-arrow-right-circle"></i>
            </a>
        </div>
    </div>
    <div class="col-xl-3 col-md-6">
        <div class="card shadow-sm border-start border-warning border-4 h-100">
            <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="card-title text-warning">BÀI CHỜ DUYỆT</h5>
                    <div class="h2 fw-bold">@ViewBag.PendingArticles</div>
                </div>
                <div class="fs-1 text-warning opacity-50"><i class="bi bi-hourglass-split"></i></div>
            </div>
            <a asp-controller="Articles" asp-area="" asp-action="Pending" class="card-footer text-warning text-decoration-none">
                Duyệt bài viết <i class="bi bi-arrow-right-circle"></i>
            </a>
        </div>
    </div>
    <div class="col-xl-3 col-md-6">
        <div class="card shadow-sm border-start border-danger border-4 h-100">
            <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="card-title text-danger">BÌNH LUẬN</h5>
                    <div class="h2 fw-bold">@ViewBag.TotalComments</div>
                </div>
                <div class="fs-1 text-danger opacity-50"><i class="bi bi-chat-dots-fill"></i></div>
            </div>
            <a asp-controller="Comments" asp-area="" asp-action="Index" class="card-footer text-danger text-decoration-none">
                Quản lý bình luận <i class="bi bi-arrow-right-circle"></i>
            </a>
        </div>
    </div>
</div>


<hr class="my-5" />

@* BIỂU ĐỒ THỐNG KÊ (Hàng 1) *@
<div class="row g-4">
    <div class="col-lg-7"> @* Biểu đồ bài viết theo tháng *@
        <div class="card shadow-sm h-100">
            <div class="card-header"><i class="bi bi-bar-chart-line-fill me-2"></i>Số bài viết đăng theo tháng (Năm nay)</div>
            <div class="card-body">
                <canvas id="articlesChart"></canvas>
            </div>
        </div>
    </div>
    <div class="col-lg-5"> @* Biểu đồ tỷ lệ danh mục *@
        <div class="card shadow-sm h-100">
            <div class="card-header"><i class="bi bi-pie-chart-fill me-2"></i>Tỷ lệ bài viết theo danh mục</div>
            <div class="card-body d-flex align-items-center justify-content-center">
                <canvas id="categoriesChart"></canvas>
            </div>
        </div>
    </div>
</div>

@* --- THÊM HÀNG BIỂU ĐỒ MỚI --- *@
<div class="row g-4 mt-4"> @* Thêm mt-4 để tạo khoảng cách *@
    <div class="col-lg-6"> @* Biểu đồ Top Tác giả *@
        <div class="card shadow-sm h-100">
            <div class="card-header"><i class="bi bi-person-lines-fill me-2"></i>Top @topAuthorLabels.Count Tác giả theo Số bài viết</div>
            <div class="card-body">
                @if (topAuthorLabels.Any())
                {
                    <canvas id="topAuthorsChart"></canvas>
                }
                else
                {
                    <p class="text-muted text-center">Chưa có dữ liệu tác giả.</p>
                }
            </div>
        </div>
    </div>
    <div class="col-lg-6"> @* Biểu đồ Top Bài viết theo Bình luận *@
        <div class="card shadow-sm h-100">
            <div class="card-header"><i class="bi bi-chat-square-dots-fill me-2"></i>Top @topCommentArticleLabels.Count Bài viết theo Số bình luận</div>
            <div class="card-body">
                 @if (topCommentArticleLabels.Any())
                {
                    <canvas id="topCommentArticlesChart"></canvas>
                }
                else
                {
                    <p class="text-muted text-center">Chưa có dữ liệu bình luận.</p>
                }
            </div>
        </div>
    </div>
</div>

<hr class="my-5" />

@* DANH SÁCH HÀNH ĐỘNG NHANH *@
<div class="row g-4">
    <div class="col-lg-7">
        <div class="card shadow-sm">    
            <div class="card-header"><i class="bi bi-card-checklist me-2"></i>Các bài viết chờ duyệt gần đây @((ViewBag.RecentPendingArticles as List<Article>)?.Count ?? 0)</div>
            <ul class="list-group list-group-flush" style="max-height: 300px; overflow-y: auto;">
                @foreach (var article in ViewBag.RecentPendingArticles)
                {
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <a asp-controller="Articles" asp-action="Details" asp-area="" asp-route-id="@article.Id" class="fw-bold text-decoration-none">@article.Title</a>
                            <small class="d-block text-muted">bởi @article.Author.UserName - @article.CreatedAt.ToString("dd/MM/yyyy")</small>
                        </div>
                        <a asp-controller="Articles" asp-action="Edit" asp-area="" asp-route-id="@article.Id" class="btn btn-sm btn-outline-primary">Duyệt ngay</a>
                    </li>
                }
            </ul>
        </div>
    </div>
</div>

<hr class="my-5" />

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        function getRandomColor(opacity = 0.6) {
            const r = Math.floor(Math.random() * 255);
            const g = Math.floor(Math.random() * 255);
            const b = Math.floor(Math.random() * 255);
            return `rgba(${r}, ${g}, ${b}, ${opacity})`;
        }
        // BIỂU ĐỒ CỘT - BÀI VIẾT THEO THÁNG
        const articlesCtx = document.getElementById('articlesChart').getContext('2d');
        new Chart(articlesCtx, {
            type: 'bar',
            data: {
                labels: @Html.Raw(Json.Serialize(ViewBag.MonthLabels)),
                datasets: [{
                    label: 'Số bài viết',
                    data: @Html.Raw(Json.Serialize(ViewBag.MonthData)),
                    backgroundColor: 'rgba(54, 162, 235, 0.6)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: { responsive: true, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
        });

        // BIỂU ĐỒ TRÒN - BÀI VIẾT THEO DANH MỤC
        const categoriesCtx = document.getElementById('categoriesChart').getContext('2d');
        new Chart(categoriesCtx, {
            type: 'doughnut',
            data: {
                labels: @Html.Raw(Json.Serialize(ViewBag.CategoryLabels)),
                datasets: [{
                    label: 'Số bài viết',
                    data: @Html.Raw(Json.Serialize(ViewBag.CategoryData)),
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.7)', 'rgba(54, 162, 235, 0.7)',
                        'rgba(255, 206, 86, 0.7)', 'rgba(75, 192, 192, 0.7)',
                        'rgba(153, 102, 255, 0.7)', 'rgba(255, 159, 64, 0.7)'
                    ],
                }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });

        // 1. BIỂU ĐỒ CỘT - TOP TÁC GIẢ
        const topAuthorsCtx = document.getElementById('topAuthorsChart')?.getContext('2d');
        if (topAuthorsCtx) {
            const topAuthorLabels = @Html.Raw(Json.Serialize(topAuthorLabels));
            const topAuthorData = @Html.Raw(Json.Serialize(topAuthorData));

            if (topAuthorLabels.length > 0) {
                new Chart(topAuthorsCtx, {
                    type: 'bar',
                    data: {
                        labels: topAuthorLabels,
                        datasets: [{
                            label: 'Số bài viết',
                            data: topAuthorData,
                            backgroundColor: topAuthorLabels.map(() => getRandomColor(0.7)), // Màu ngẫu nhiên cho mỗi cột
                            borderColor: topAuthorLabels.map(() => getRandomColor(1)),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        indexAxis: 'y', // Hiển thị dạng cột ngang cho dễ đọc tên tác giả
                        responsive: true,
                        plugins: { legend: { display: false } }, // Ẩn chú thích (label đã rõ)
                        scales: { x: { beginAtZero: true, ticks: { stepSize: 1 } } }
                    }
                });
            }
        }

        // 2. BIỂU ĐỒ CỘT - TOP BÀI VIẾT THEO BÌNH LUẬN
        const topCommentArticlesCtx = document.getElementById('topCommentArticlesChart')?.getContext('2d');
        if (topCommentArticlesCtx) {
            const topCommentArticleLabels = @Html.Raw(Json.Serialize(topCommentArticleLabels));
            const topCommentArticleData = @Html.Raw(Json.Serialize(topCommentArticleData));

            // Rút gọn tên bài viết nếu quá dài cho biểu đồ
            const shortLabels = topCommentArticleLabels.map(label => label.length > 30 ? label.substring(0, 27) + '...' : label);

            if (shortLabels.length > 0) {
                new Chart(topCommentArticlesCtx, {
                    type: 'bar',
                    data: {
                        labels: shortLabels, // Dùng tên đã rút gọn
                        datasets: [{
                            label: 'Số bình luận',
                            data: topCommentArticleData,
                            backgroundColor: shortLabels.map(() => getRandomColor(0.7)),
                            borderColor: shortLabels.map(() => getRandomColor(1)),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        indexAxis: 'y', // Cột ngang
                        responsive: true,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                // Hiển thị tên đầy đủ khi hover vào cột
                                callbacks: {
                                    title: function (tooltipItems) {
                                        // tooltipItems[0].dataIndex là chỉ số của cột đang hover
                                        return topCommentArticleLabels[tooltipItems[0].dataIndex];
                                    }
                                }
                            }
                        },
                        scales: { x: { beginAtZero: true, ticks: { stepSize: 1 } } }
                    }
                });
            }
        }
    </script>
}